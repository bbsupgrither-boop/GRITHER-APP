name: Smart Deploy to Render

on:
  push:
    branches: [ main ]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      backend: ${{ steps.changes.outputs.backend }}
      config: ${{ steps.changes.outputs.config }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Detect changes
        id: changes
        run: |
          echo "ğŸ” Detecting changes..."
          
          # Get changed files
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Check for frontend changes (only frontend/ folder)
          if echo "$CHANGED_FILES" | grep -E '^frontend/'; then
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "âœ… Frontend changes detected"
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
            echo "âŒ No frontend changes"
          fi
          
          # Check for backend changes (only backend/ folder)
          if echo "$CHANGED_FILES" | grep -E '^backend/'; then
            echo "backend=true" >> $GITHUB_OUTPUT
            echo "âœ… Backend changes detected"
          else
            echo "backend=false" >> $GITHUB_OUTPUT
            echo "âŒ No backend changes"
          fi
          
          # Check for config changes
          if echo "$CHANGED_FILES" | grep -E '^render\.yaml$|^package\.json$'; then
            echo "config=true" >> $GITHUB_OUTPUT
            echo "âœ… Config changes detected"
          else
            echo "config=false" >> $GITHUB_OUTPUT
            echo "âŒ No config changes"
          fi

  deploy-frontend:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true' || needs.detect-changes.outputs.config == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Frontend
        run: |
          echo "ğŸš€ Frontend deployment triggered"
          echo "Reason: Frontend changes: ${{ needs.detect-changes.outputs.frontend }}"
          echo "Reason: Config changes: ${{ needs.detect-changes.outputs.config }}"
          echo "Render will deploy frontend automatically"

  deploy-backend:
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true' || needs.detect-changes.outputs.config == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Backend
        run: |
          echo "ğŸš€ Backend deployment triggered"
          echo "Reason: Backend changes: ${{ needs.detect-changes.outputs.backend }}"
          echo "Reason: Config changes: ${{ needs.detect-changes.outputs.config }}"
          echo "Render will deploy backend automatically"

  deploy-summary:
    needs: [detect-changes, deploy-frontend, deploy-backend]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Summary
        run: |
          echo "ğŸ“‹ Deploy Summary:"
          echo "Frontend changes: ${{ needs.detect-changes.outputs.frontend }}"
          echo "Backend changes: ${{ needs.detect-changes.outputs.backend }}"
          echo "Config changes: ${{ needs.detect-changes.outputs.config }}"
          echo ""
          echo "ğŸ¯ Render will deploy only the services that need updates!"
