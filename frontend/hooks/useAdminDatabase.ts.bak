import { useState, useEffect, useCallback } from 'react';
import { databaseService, UserData, AchievementData, TaskData, NotificationData, BattleData } from '../services/database';

export interface ShopItemData {
  id: string;
  name: string;
  description: string;
  category: 'cases' | 'boosters' | 'cosmetics' | 'exclusive';
  price: number;
  image: string;
  icon: string;
  rarity: 'common' | 'rare' | 'epic' | 'legendary';
  isActive: boolean;
  salesCount: number;
  popularity: number;
  createdAt: string;
}

export interface AppDatabase {
  users: UserData[];
  achievements: AchievementData[];
  tasks: TaskData[];
  battles: BattleData[];
  shopItems: ShopItemData[];
  notifications: NotificationData[];
}

interface UseAdminDatabaseReturn {
  database: AppDatabase;
  updateDatabase: (updates: Partial<AppDatabase>) => void;
  isLoading: boolean;
  error: string | null;
  
  // Р СљР ВµРЎвЂљР С•Р Т‘РЎвЂ№ Р Т‘Р В»РЎРЏ РЎР‚Р В°Р В±Р С•РЎвЂљРЎвЂ№ РЎРѓ Р Т‘Р В°Р Р…Р Р…РЎвЂ№Р СР С‘
  addUser: (user: UserData) => boolean;
  updateUser: (userId: string, updates: Partial<UserData>) => boolean;
  deleteUser: (userId: string) => boolean;
  
  addAchievement: (achievement: AchievementData) => boolean;
  updateAchievement: (achievementId: string, updates: Partial<AchievementData>) => boolean;
  deleteAchievement: (achievementId: string) => boolean;
  
  addTask: (task: TaskData) => boolean;
  updateTask: (taskId: string, updates: Partial<TaskData>) => boolean;
  deleteTask: (taskId: string) => boolean;
  
  addBattle: (battle: BattleData) => boolean;
  updateBattle: (battleId: string, updates: Partial<BattleData>) => boolean;
  deleteBattle: (battleId: string) => boolean;
  
  addShopItem: (item: ShopItemData) => boolean;
  updateShopItem: (itemId: string, updates: Partial<ShopItemData>) => boolean;
  deleteShopItem: (itemId: string) => boolean;
  
  addNotification: (notification: NotificationData) => boolean;
  updateNotification: (notificationId: string, updates: Partial<NotificationData>) => boolean;
  deleteNotification: (notificationId: string) => boolean;
}

export const useAdminDatabase = (): UseAdminDatabaseReturn => {
  const [database, setDatabase] = useState<AppDatabase>({
    users: [],
    achievements: [],
    tasks: [],
    battles: [],
    shopItems: [],
    notifications: []
  });
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // Р вЂ”Р В°Р С–РЎР‚РЎС“Р В·Р С”Р В° Р Р†РЎРѓР ВµРЎвЂ¦ Р Т‘Р В°Р Р…Р Р…РЎвЂ№РЎвЂ¦ Р С‘Р В· localStorage
  const loadDatabase = useCallback(() => {
    try {
      setIsLoading(true);
      setError(null);

      // Р СџР С•Р В»РЎС“РЎвЂЎР В°Р ВµР С Р Р†РЎРѓР Вµ Р Т‘Р В°Р Р…Р Р…РЎвЂ№Р Вµ Р С‘Р В· localStorage
      const users: UserData[] = [];
      const achievements: AchievementData[] = [];
      const tasks: TaskData[] = [];
      const battles: BattleData[] = [];
      const shopItems: ShopItemData[] = [];
      const notifications: NotificationData[] = [];

      // Р СџР С•Р В»РЎС“РЎвЂЎР В°Р ВµР С Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»Р ВµР в„–
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key?.startsWith('grither_db_user_')) {
          const userData = localStorage.getItem(key);
          if (userData) {
            users.push(JSON.parse(userData));
          }
        }
      }

      // Р СџР С•Р В»РЎС“РЎвЂЎР В°Р ВµР С Р Т‘Р С•РЎРѓРЎвЂљР С‘Р В¶Р ВµР Р…Р С‘РЎРЏ
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key?.startsWith('grither_db_achievement_')) {
          const achievementData = localStorage.getItem(key);
          if (achievementData) {
            achievements.push(JSON.parse(achievementData));
          }
        }
      }

      // Р СџР С•Р В»РЎС“РЎвЂЎР В°Р ВµР С Р В·Р В°Р Т‘Р В°РЎвЂЎР С‘
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key?.startsWith('grither_db_task_')) {
          const taskData = localStorage.getItem(key);
          if (taskData) {
            tasks.push(JSON.parse(taskData));
          }
        }
      }

      // Р СџР С•Р В»РЎС“РЎвЂЎР В°Р ВµР С Р В±Р В°РЎвЂљРЎвЂљР В»РЎвЂ№
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key?.startsWith('grither_db_battle_')) {
          const battleData = localStorage.getItem(key);
          if (battleData) {
            battles.push(JSON.parse(battleData));
          }
        }
      }

      // Р СџР С•Р В»РЎС“РЎвЂЎР В°Р ВµР С РЎвЂљР С•Р Р†Р В°РЎР‚РЎвЂ№ Р СР В°Р С–Р В°Р В·Р С‘Р Р…Р В°
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key?.startsWith('grither_db_shop_')) {
          const shopData = localStorage.getItem(key);
          if (shopData) {
            shopItems.push(JSON.parse(shopData));
          }
        }
      }

      // Р СџР С•Р В»РЎС“РЎвЂЎР В°Р ВµР С РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key?.startsWith('grither_db_notification_')) {
          const notificationData = localStorage.getItem(key);
          if (notificationData) {
            notifications.push(JSON.parse(notificationData));
          }
        }
      }

      setDatabase({
        users,
        achievements,
        tasks,
        battles,
        shopItems,
        notifications
      });

    } catch (err) {
      console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р С‘ Р В±Р В°Р В·РЎвЂ№ Р Т‘Р В°Р Р…Р Р…РЎвЂ№РЎвЂ¦:', err);
      setError('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р С‘ Р В±Р В°Р В·РЎвЂ№ Р Т‘Р В°Р Р…Р Р…РЎвЂ№РЎвЂ¦');
    } finally {
      setIsLoading(false);
    }
  }, []);

  // Р С’Р Р†РЎвЂљР С•Р СР В°РЎвЂљР С‘РЎвЂЎР ВµРЎРѓР С”Р В°РЎРЏ Р В·Р В°Р С–РЎР‚РЎС“Р В·Р С”Р В° Р С—РЎР‚Р С‘ Р СР С•Р Р…РЎвЂљР С‘РЎР‚Р С•Р Р†Р В°Р Р…Р С‘Р С‘
  useEffect(() => {
    loadDatabase();
  }, [loadDatabase]);

  // Р С›Р В±Р Р…Р С•Р Р†Р В»Р ВµР Р…Р С‘Р Вµ Р В±Р В°Р В·РЎвЂ№ Р Т‘Р В°Р Р…Р Р…РЎвЂ№РЎвЂ¦
  const updateDatabase = useCallback((updates: Partial<AppDatabase>) => {
    setDatabase(prev => ({ ...prev, ...updates }));
  }, []);

  // Р СљР ВµРЎвЂљР С•Р Т‘РЎвЂ№ Р Т‘Р В»РЎРЏ РЎР‚Р В°Р В±Р С•РЎвЂљРЎвЂ№ РЎРѓ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏР СР С‘
  const addUser = useCallback((user: UserData): boolean => {
    try {
      const success = databaseService.saveUser(user);
      if (success) {
        loadDatabase();
      }
      return success;
    } catch (err) {
      console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р Т‘Р С•Р В±Р В°Р Р†Р В»Р ВµР Р…Р С‘РЎРЏ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ:', err);
      return false;
    }
  }, [loadDatabase]);

  const updateUser = useCallback((userId: string, updates: Partial<UserData>): boolean => {
    try {
      const user = database.users.find(u => u.telegramId === userId);
      if (!user) return false;

      const updatedUser = { ...user, ...updates };
      const success = databaseService.saveUser(updatedUser);
      if (success) {
        loadDatabase();
      }
      return success;
    } catch (err) {
      console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р С•Р В±Р Р…Р С•Р Р†Р В»Р ВµР Р…Р С‘РЎРЏ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ:', err);
      return false;
    }
  }, [database.users, loadDatabase]);

  const deleteUser = useCallback((userId: string): boolean => {
    try {
      localStorage.removeItem(`grither_db_user_${userId}`);
      loadDatabase();
      return true;
    } catch (err) {
      console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С‘РЎРЏ Р С—Р С•Р В»РЎРЉР В·Р С•Р Р†Р В°РЎвЂљР ВµР В»РЎРЏ:', err);
      return false;
    }
  }, [loadDatabase]);

  // Р СљР ВµРЎвЂљР С•Р Т‘РЎвЂ№ Р Т‘Р В»РЎРЏ РЎР‚Р В°Р В±Р С•РЎвЂљРЎвЂ№ РЎРѓ Р Т‘Р С•РЎРѓРЎвЂљР С‘Р В¶Р ВµР Р…Р С‘РЎРЏР СР С‘
  const addAchievement = useCallback((achievement: AchievementData): boolean => {
    try {
      const success = databaseService.saveAchievement(achievement);
      if (success) {
        loadDatabase();
      }
      return success;
    } catch (err) {
      console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р Т‘Р С•Р В±Р В°Р Р†Р В»Р ВµР Р…Р С‘РЎРЏ Р Т‘Р С•РЎРѓРЎвЂљР С‘Р В¶Р ВµР Р…Р С‘РЎРЏ:', err);
      return false;
    }
  }, [loadDatabase]);

  const updateAchievement = useCallback((achievementId: string, updates: Partial<AchievementData>): boolean => {
    try {
      const achievement = database.achievements.find(a => a.id === achievementId);
      if (!achievement) return false;

      const updatedAchievement = { ...achievement, ...updates };
      const success = databaseService.saveAchievement(updatedAchievement);
      if (success) {
        loadDatabase();
      }
      return success;
    } catch (err) {
      console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р С•Р В±Р Р…Р С•Р Р†Р В»Р ВµР Р…Р С‘РЎРЏ Р Т‘Р С•РЎРѓРЎвЂљР С‘Р В¶Р ВµР Р…Р С‘РЎРЏ:', err);
      return false;
    }
  }, [database.achievements, loadDatabase]);

  const deleteAchievement = useCallback((achievementId: string): boolean => {
    try {
      localStorage.removeItem(`grither_db_achievement_${achievementId}`);
      loadDatabase();
      return true;
    } catch (err) {
      console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С‘РЎРЏ Р Т‘Р С•РЎРѓРЎвЂљР С‘Р В¶Р ВµР Р…Р С‘РЎРЏ:', err);
      return false;
    }
  }, [loadDatabase]);

  // Р СљР ВµРЎвЂљР С•Р Т‘РЎвЂ№ Р Т‘Р В»РЎРЏ РЎР‚Р В°Р В±Р С•РЎвЂљРЎвЂ№ РЎРѓ Р В·Р В°Р Т‘Р В°РЎвЂЎР В°Р СР С‘
  const addTask = useCallback((task: TaskData): boolean => {
    try {
      const success = databaseService.saveTask(task);
      if (success) {
        loadDatabase();
      }
      return success;
    } catch (err) {
      console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р Т‘Р С•Р В±Р В°Р Р†Р В»Р ВµР Р…Р С‘РЎРЏ Р В·Р В°Р Т‘Р В°РЎвЂЎР С‘:', err);
      return false;
    }
  }, [loadDatabase]);

  const updateTask = useCallback((taskId: string, updates: Partial<TaskData>): boolean => {
    try {
      const task = database.tasks.find(t => t.id === taskId);
      if (!task) return false;

      const updatedTask = { ...task, ...updates };
      const success = databaseService.saveTask(updatedTask);
      if (success) {
        loadDatabase();
      }
      return success;
    } catch (err) {
      console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р С•Р В±Р Р…Р С•Р Р†Р В»Р ВµР Р…Р С‘РЎРЏ Р В·Р В°Р Т‘Р В°РЎвЂЎР С‘:', err);
      return false;
    }
  }, [database.tasks, loadDatabase]);

  const deleteTask = useCallback((taskId: string): boolean => {
    try {
      localStorage.removeItem(`grither_db_task_${taskId}`);
      loadDatabase();
      return true;
    } catch (err) {
      console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С‘РЎРЏ Р В·Р В°Р Т‘Р В°РЎвЂЎР С‘:', err);
      return false;
    }
  }, [loadDatabase]);

  // Р СљР ВµРЎвЂљР С•Р Т‘РЎвЂ№ Р Т‘Р В»РЎРЏ РЎР‚Р В°Р В±Р С•РЎвЂљРЎвЂ№ РЎРѓ Р В±Р В°РЎвЂљРЎвЂљР В»Р В°Р СР С‘
  const addBattle = useCallback((battle: BattleData): boolean => {
    try {
      localStorage.setItem(`grither_db_battle_${battle.id}`, JSON.stringify(battle));
      loadDatabase();
      return true;
    } catch (err) {
      console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р Т‘Р С•Р В±Р В°Р Р†Р В»Р ВµР Р…Р С‘РЎРЏ Р В±Р В°РЎвЂљРЎвЂљР В»Р В°:', err);
      return false;
    }
  }, [loadDatabase]);

  const updateBattle = useCallback((battleId: string, updates: Partial<BattleData>): boolean => {
    try {
      const battle = database.battles.find(b => b.id === battleId);
      if (!battle) return false;

      const updatedBattle = { ...battle, ...updates };
      localStorage.setItem(`grither_db_battle_${battleId}`, JSON.stringify(updatedBattle));
      loadDatabase();
      return true;
    } catch (err) {
      console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р С•Р В±Р Р…Р С•Р Р†Р В»Р ВµР Р…Р С‘РЎРЏ Р В±Р В°РЎвЂљРЎвЂљР В»Р В°:', err);
      return false;
    }
  }, [database.battles, loadDatabase]);

  const deleteBattle = useCallback((battleId: string): boolean => {
    try {
      localStorage.removeItem(`grither_db_battle_${battleId}`);
      loadDatabase();
      return true;
    } catch (err) {
      console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С‘РЎРЏ Р В±Р В°РЎвЂљРЎвЂљР В»Р В°:', err);
      return false;
    }
  }, [loadDatabase]);

  // Р СљР ВµРЎвЂљР С•Р Т‘РЎвЂ№ Р Т‘Р В»РЎРЏ РЎР‚Р В°Р В±Р С•РЎвЂљРЎвЂ№ РЎРѓ РЎвЂљР С•Р Р†Р В°РЎР‚Р В°Р СР С‘ Р СР В°Р С–Р В°Р В·Р С‘Р Р…Р В°
  const addShopItem = useCallback((item: ShopItemData): boolean => {
    try {
      localStorage.setItem(`grither_db_shop_${item.id}`, JSON.stringify(item));
      loadDatabase();
      return true;
    } catch (err) {
      console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р Т‘Р С•Р В±Р В°Р Р†Р В»Р ВµР Р…Р С‘РЎРЏ РЎвЂљР С•Р Р†Р В°РЎР‚Р В°:', err);
      return false;
    }
  }, [loadDatabase]);

  const updateShopItem = useCallback((itemId: string, updates: Partial<ShopItemData>): boolean => {
    try {
      const item = database.shopItems.find(i => i.id === itemId);
      if (!item) return false;

      const updatedItem = { ...item, ...updates };
      localStorage.setItem(`grither_db_shop_${itemId}`, JSON.stringify(updatedItem));
      loadDatabase();
      return true;
    } catch (err) {
      console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р С•Р В±Р Р…Р С•Р Р†Р В»Р ВµР Р…Р С‘РЎРЏ РЎвЂљР С•Р Р†Р В°РЎР‚Р В°:', err);
      return false;
    }
  }, [database.shopItems, loadDatabase]);

  const deleteShopItem = useCallback((itemId: string): boolean => {
    try {
      localStorage.removeItem(`grither_db_shop_${itemId}`);
      loadDatabase();
      return true;
    } catch (err) {
      console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С‘РЎРЏ РЎвЂљР С•Р Р†Р В°РЎР‚Р В°:', err);
      return false;
    }
  }, [loadDatabase]);

  // Р СљР ВµРЎвЂљР С•Р Т‘РЎвЂ№ Р Т‘Р В»РЎРЏ РЎР‚Р В°Р В±Р С•РЎвЂљРЎвЂ№ РЎРѓ РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏР СР С‘
  const addNotification = useCallback((notification: NotificationData): boolean => {
    try {
      const success = databaseService.saveNotification(notification);
      if (success) {
        loadDatabase();
      }
      return success;
    } catch (err) {
      console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р Т‘Р С•Р В±Р В°Р Р†Р В»Р ВµР Р…Р С‘РЎРЏ РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ:', err);
      return false;
    }
  }, [loadDatabase]);

  const updateNotification = useCallback((notificationId: string, updates: Partial<NotificationData>): boolean => {
    try {
      const notification = database.notifications.find(n => n.id === notificationId);
      if (!notification) return false;

      const updatedNotification = { ...notification, ...updates };
      const success = databaseService.saveNotification(updatedNotification);
      if (success) {
        loadDatabase();
      }
      return success;
    } catch (err) {
      console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° Р С•Р В±Р Р…Р С•Р Р†Р В»Р ВµР Р…Р С‘РЎРЏ РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ:', err);
      return false;
    }
  }, [database.notifications, loadDatabase]);

  const deleteNotification = useCallback((notificationId: string): boolean => {
    try {
      localStorage.removeItem(`grither_db_notification_${notificationId}`);
      loadDatabase();
      return true;
    } catch (err) {
      console.error('Р С›РЎв‚¬Р С‘Р В±Р С”Р В° РЎС“Р Т‘Р В°Р В»Р ВµР Р…Р С‘РЎРЏ РЎС“Р Р†Р ВµР Т‘Р С•Р СР В»Р ВµР Р…Р С‘РЎРЏ:', err);
      return false;
    }
  }, [loadDatabase]);

  return {
    database,
    updateDatabase,
    isLoading,
    error,
    addUser,
    updateUser,
    deleteUser,
    addAchievement,
    updateAchievement,
    deleteAchievement,
    addTask,
    updateTask,
    deleteTask,
    addBattle,
    updateBattle,
    deleteBattle,
    addShopItem,
    updateShopItem,
    deleteShopItem,
    addNotification,
    updateNotification,
    deleteNotification
  };
};
