import { useState, useEffect } from 'react';
import { useThemeToggle } from './useThemeToggle';

export type Theme = 'light' | 'dark';

export const useTheme = () => {
  const [theme, setTheme] = useState<Theme>('dark'); // Р СџР С• РЎС“Р СР С•Р В»РЎвЂЎР В°Р Р…Р С‘РЎР‹ РЎвЂљР ВµР СР Р…Р В°РЎРЏ РЎвЂљР ВµР СР В°
  const { themeToggleCount, incrementThemeToggleCount, resetThemeToggleCount } = useThemeToggle();

  // Р СџРЎР‚Р С‘Р СР ВµР Р…Р ВµР Р…Р С‘Р Вµ РЎвЂљР ВµР СРЎвЂ№ Р С” DOM
  useEffect(() => {
    if (theme === 'dark') {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  }, [theme]);

  // Р ВР Р…Р С‘РЎвЂ Р С‘Р В°Р В»Р С‘Р В·Р В°РЎвЂ Р С‘РЎРЏ РЎвЂљР ВµР СРЎвЂ№ Р С‘Р В· localStorage Р С‘Р В»Р С‘ РЎРѓР С‘РЎРѓРЎвЂљР ВµР СР Р…РЎвЂ№РЎвЂ¦ Р Р…Р В°РЎРѓРЎвЂљРЎР‚Р С•Р ВµР С”
  useEffect(() => {
    // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С localStorage
    const savedTheme = localStorage.getItem('grither-theme') as Theme;
    if (savedTheme && (savedTheme === 'light' || savedTheme === 'dark')) {
      setTheme(savedTheme);
      return;
    }

    // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С РЎРѓР С‘РЎРѓРЎвЂљР ВµР СР Р…РЎС“РЎР‹ РЎвЂљР ВµР СРЎС“
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
      setTheme('light');
    }

    // Р СџРЎР‚Р С•Р Р†Р ВµРЎР‚РЎРЏР ВµР С Telegram Web App
    if (window.Telegram && window.Telegram.WebApp) {
      const telegramTheme = window.Telegram.WebApp.colorScheme === 'light' ? 'light' : 'dark';
      setTheme(telegramTheme);
    }
  }, []);

  // Р В¤РЎС“Р Р…Р С”РЎвЂ Р С‘РЎРЏ Р С—Р ВµРЎР‚Р ВµР С”Р В»РЎР‹РЎвЂЎР ВµР Р…Р С‘РЎРЏ РЎвЂљР ВµР СРЎвЂ№
  const toggleTheme = () => {
    const newTheme = theme === 'light' ? 'dark' : 'light';
    console.log(`СЂСџРЉвЂ” Theme toggle: ${theme} РІвЂ вЂ™ ${newTheme}`);
    setTheme(newTheme);
    localStorage.setItem('grither-theme', newTheme);
    
    // Р Р€Р Р†Р ВµР В»Р С‘РЎвЂЎР С‘Р Р†Р В°Р ВµР С РЎРѓРЎвЂЎР ВµРЎвЂљРЎвЂЎР С‘Р С” Р С—Р ВµРЎР‚Р ВµР С”Р В»РЎР‹РЎвЂЎР ВµР Р…Р С‘Р в„– РЎвЂљР С•Р В»РЎРЉР С”Р С• Р С—РЎР‚Р С‘ Р Р†Р С”Р В»РЎР‹РЎвЂЎР ВµР Р…Р С‘Р С‘ (light -> dark)
    if (newTheme === 'dark') {
      console.log(`СЂСџвЂќСћ Incrementing theme toggle count: ${themeToggleCount} РІвЂ вЂ™ ${themeToggleCount + 1}`);
      incrementThemeToggleCount();
    }
  };

  // Р В¤РЎС“Р Р…Р С”РЎвЂ Р С‘РЎРЏ РЎС“РЎРѓРЎвЂљР В°Р Р…Р С•Р Р†Р С”Р С‘ Р С”Р С•Р Р…Р С”РЎР‚Р ВµРЎвЂљР Р…Р С•Р в„– РЎвЂљР ВµР СРЎвЂ№
  const setThemeMode = (newTheme: Theme) => {
    setTheme(newTheme);
    localStorage.setItem('grither-theme', newTheme);
  };

  return {
    theme,
    toggleTheme,
    setTheme: setThemeMode,
    isDark: theme === 'dark',
    isLight: theme === 'light',
    themeToggleCount,
    resetThemeToggleCount
  };
};
